{% set active_page = "corpus" %}
{% include "header.html" %}
<div class="container-fluid p-3">
    <div class="row">
        <div class="col-sm-7">
            <span id="corpus-title" class="lead"></span>
            <table id="corpus_viewer" class="table table-bordered table-hover" data-toggle="table"
                data-url="{{url_for('api_corpus', chapter_id=data.chapter_id)}}"
                data-response-handler="response_handler"
                data-toolbar="#corpus-title"
                data-unique-id="verse_id"
                data-cache="false"
                data-search="true"
                data-search-highlight="true"
                data-show-refresh="true"
                data-show-toggle="true"
                data-show-columns="true"
                data-pagination="true"
                data-page-list="[10, 25, 50, 100, 200, All]"
                data-show-jump-to="true"
                data-show-jump-to-by-pages="10"
                data-click-to-select="true"
                data-detail-view="true"
                data-detail-view-icon="false"
                data-detail-formatter="{{config.row_detail_formatter}}_row_detail_formatter"
                data-row-attributes="row_attribute_handler"
                data-key-events="true"
                data-sticky-header="true"
                data-sticky-header-offset-left="1%"
                data-sticky-header-offset-right="26%">
                <thead>
                    <tr>
                        <th scope="col" data-field="edit" data-radio="true"></th>
                        <!-- <th scope="col" data-field="line_id" data-sortable="true">
                            Line
                        </th> -->
                        <th scope="col" data-field="verse_id">
                            Verse
                        </th>
                        <th scope="col" data-field="text" data-formatter="column_text_formatter">
                            Text
                        </th>
                        <th scope="col" data-field="marked" data-align="center" data-formatter="column_marked_formatter" data-card-visible="false">
                            <i class="fa fa-question"></i>
                        </th>
                    </tr>
                </thead>
            </table>
        </div>
        <div class="col-sm-5 sticky-top align-self-start">
            <!-- For "sticky-top" to work on a "col" element requires "align-self-start" class as well. -->
            <div class="scroll-large">
            {% if current_user.has_permission("annotate") %}
            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item">
                  <a class="nav-link active" id="task-1-tab" data-toggle="pill" href="#task-1-tab-content" role="tab" aria-controls="task-1-tab-content" aria-selected="true">Task 1</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="task-2-tab" data-toggle="pill" href="#task-2-tab-content" role="tab" aria-controls="task-2-tab-content" aria-selected="false">Task 2</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" id="task-3-tab" data-toggle="pill" href="#task-3-tab-content" role="tab" aria-controls="task-3-tab-content" aria-selected="false">Task 3</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="task-4-tab" data-toggle="pill" href="#task-4-tab-content" role="tab" aria-controls="task-4-tab-content" aria-selected="false">Task 4</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="task-5-tab" data-toggle="pill" href="#task-5-tab-content" role="tab" aria-controls="task-5-tab-content" aria-selected="false">Task 5</a>
                </li>
            </ul>

            <div class="tab-content" id="pills-tab-content">
                <div class="tab-pane active" id="task-1-tab-content" role="tabpanel" aria-labelledby="task-1-tab">
                    {% include "task_1.html" %}
                </div>
                <div class="tab-pane" id="task-2-tab-content" role="tabpanel" aria-labelledby="task-2-tab">
                    {% include "task_2.html" %}
                </div>
                <div class="tab-pane" id="task-3-tab-content" role="tabpanel" aria-labelledby="task-3-tab">
                    {% include "task_3.html" %}
                </div>
                <div class="tab-pane" id="task-4-tab-content" role="tabpanel" aria-labelledby="task-4-tab">
                    {% include "task_4.html" %}
                </div>
                <div class="tab-pane" id="task-5-tab-content" role="tabpanel" aria-labelledby="task-5-tab">
                    {% include "task_5.html" %}
                </div>
            </div>

            {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // used in individual tasks
    const api_url = "{{url_for('api')}}";
    const current_username = "{{current_user.username}}";
</script>
<script src="{{url_for('static', filename='custom/js/corpus/elements.js')}}"></script>
<script src="{{url_for('static', filename='custom/js/corpus/events.js')}}"></script>
<script src="{{url_for('static', filename='custom/js/corpus/functions.js')}}"></script>

<script>
/* ********************  Skip Actions ******************** */

$('a[data-toggle="tab"]').on('shown.bs.tab', function (event) {
    const active_tab = event.target;
    const previous_tab = event.relatedTarget;
    console.log(active_tab);
});

$task_1_skip.click(function () {
    $task_1_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 1 Skip Actions
    // ...
    $task_2_tab.click();
    $task_2_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
});
$task_2_skip.click(function () {
    $task_2_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 2 Actions
    // ...
    $task_3_tab.click();
    // $task_3_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();

});
$task_3_skip.click(function () {
    // $task_3_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 3 Skip Actions
    // ...
    $task_4_tab.click();
    $task_4_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
});
$task_4_skip.click(function () {
    $task_4_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 4 Skip Actions
    // ...
    $task_5_tab.click();
    $task_5_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
});
$task_5_skip.click(function() {
    $task_5_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 5 Skip Actions
    // ...
    $task_1_tab.click();
    $corpus_table.bootstrapTable('collapseAllRows');
    $corpus_table.bootstrapTable('uncheckAll');
    $corpus_table.bootstrapTable('expandRowByUniqueId', storage.getItem("next"));
});
</script>
<script>
/* ********************  Submit Actions ******************** */

$task_1_submit.click(function () {
    $task_1_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');

    // Identify Boundary Token IDs
    var marker_positions = $task_1_input.data('marker_positions');
    var submitted_tokens = $task_1_input.val().split(/\s+/);
    var line_break_tokens = [];

    var current_idx = -2;
    for (var i=0; i < submitted_tokens.length; ++i) {
        if (submitted_tokens[i] === "##") {
            line_break_tokens.push(marker_positions[current_idx]);
        } else {
            current_idx += 1;
        }
    }

    $.post(api_url, {
        action: "update_sentence_boundary",
        verse_id: $verse_id_containers.html(),
        boundaries: line_break_tokens.join(","),
    },
    function (response) {
        $.notify({
            message: response.message
        }, {
            type: response.style
        });

        if (response.success) {
            var boundary_objects = [];
            $.each(line_break_tokens, function(index, _token_id) {
                boundary_objects.push({
                    'token_id': _token_id,
                    'verse_id': $verse_id_containers.html(),
                    'annotator': current_username,
                    'is_deleted': false
                });
            })
            // update local table
            var current_row = $corpus_table.bootstrapTable('getRowByUniqueId', $verse_id_containers.html());
            current_row.marked = true;
            current_row.boundary = boundary_objects;

            $corpus_table.bootstrapTable('updateByUniqueId', {
                verse_id: current_row.verse_id,
                row: current_row
            });

            // move to the next task
            $task_2_tab.click();
            $task_2_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
        }
    },
    'json');
});
$task_2_submit.click(function () {
    $task_2_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 2 Actions

    $.post(api_url, {
        action: "update_multiword_type",
        verse_id: $verse_id_containers.html(),
    },
    function (response) {
        $.notify({
            message: response.message
        }, {
            type: response.style
        });

        if (response.success) {
            // ....
            $task_3_tab.click();
            // $task_3_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
        }
    });
});
$task_3_submit.click(function () {
    // $task_3_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');
    // Task 3 Actions

    var anvaya_data = {}
    $('.sortable').each(function(sentence_index, sentence_element) {
        const boundary_id = sentence_element.id;
        anvaya_data[boundary_id] = $(sentence_element).data("anvaya");
    });
    console.log(anvaya_data);

    $.post(api_url, {
        action: "update_anvaya",
        verse_id: $verse_id_containers.html(),
        anvaya: JSON.stringify(anvaya_data)
    },
    function (response) {
        $.notify({
            message: response.message
        }, {
            type: response.style
        });

        if (response.success) {
            // ....
            $task_4_tab.click();
            $task_4_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
        }
    });
});
$task_4_submit.click(function () {
    $task_4_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');

    $.post(api_url, {
        action: "update_action_graph",
        verse_id: $verse_id_containers.html(),
    },
    function (response) {
        $.notify({
            message: response.message
        }, {
            type: response.style
        });

        if (response.success) {
            // ....
            $task_5_tab.click();
            $task_5_input.prop('disabled', false).removeClass('text-muted').addClass('text-info').focus();
        }
    });
});
$task_5_submit.click(function() {
    $task_5_input.prop('disabled', true).removeClass('text-info').addClass('text-muted');

    $.post(api_url, {
        action: "update_coreference",
        verse_id: $verse_id_containers.html(),
    },
    function (response) {
        $.notify({
            message: response.message
        }, {
            type: response.style
        });

        if (response.success) {
            // ....
            $task_1_tab.click();
            $corpus_table.bootstrapTable('collapseAllRows');
            $corpus_table.bootstrapTable('uncheckAll');
            $corpus_table.bootstrapTable('expandRowByUniqueId', storage.getItem("next"));
        }
    });
});
</script>
{% include "footer.html" %}